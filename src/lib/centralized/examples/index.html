<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Association with GunDB</title>
    <!-- Gun and SEA libraries -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/then.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            border: none;
            padding: 10px 15px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .hidden {
            display: none;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
        }
        .tab.active {
            border-bottom: 3px solid #3498db;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-column {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Free Association Protocol Demo</h1>
        
        <!-- Authentication Panel -->
        <div id="auth-panel" class="panel">
            <h2>Authentication</h2>
            <div id="login-form">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <button id="login-btn">Login</button>
                    <button id="signup-btn">Sign Up</button>
                </div>
                <div id="auth-message"></div>
            </div>
            <div id="user-info" class="hidden">
                <p>Logged in as: <span id="current-user"></span></p>
                <button id="logout-btn">Logout</button>
            </div>
        </div>
        
        <!-- Main Content (visible after login) -->
        <div id="main-content" class="hidden">
            <div class="tabs">
                <div class="tab active" data-tab="trees">Trees</div>
                <div class="tab" data-tab="capacities">Capacities</div>
                <div class="tab" data-tab="shares">Capacity Shares</div>
            </div>
            
            <!-- Trees Tab -->
            <div id="trees-tab" class="tab-content active">
                <h2>Your Trees</h2>
                <div class="flex-container">
                    <div class="flex-column">
                        <div class="panel">
                            <h3>Create New Tree</h3>
                            <div class="form-group">
                                <label for="tree-name">Tree Name:</label>
                                <input type="text" id="tree-name" placeholder="Enter tree name">
                            </div>
                            <div class="form-group">
                                <label for="tree-points">Points:</label>
                                <input type="number" id="tree-points" value="100">
                            </div>
                            <div class="form-group">
                                <label for="tree-contributors">Contributors (comma-separated IDs):</label>
                                <input type="text" id="tree-contributors" placeholder="ID1,ID2,...">
                            </div>
                            <button id="create-tree-btn">Create Tree</button>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="panel">
                            <h3>Your Trees</h3>
                            <div id="trees-list">
                                <p>No trees found.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Capacities Tab -->
            <div id="capacities-tab" class="tab-content">
                <h2>Capacities</h2>
                <div class="flex-container">
                    <div class="flex-column">
                        <div class="panel">
                            <h3>Create New Capacity</h3>
                            <div class="form-group">
                                <label for="capacity-tree">Select Tree:</label>
                                <select id="capacity-tree"></select>
                            </div>
                            <div class="form-group">
                                <label for="capacity-name">Name:</label>
                                <input type="text" id="capacity-name" placeholder="Enter capacity name">
                            </div>
                            <div class="form-group">
                                <label for="capacity-quantity">Quantity:</label>
                                <input type="number" id="capacity-quantity" value="10">
                            </div>
                            <div class="form-group">
                                <label for="capacity-unit">Unit:</label>
                                <input type="text" id="capacity-unit" placeholder="hours, slots, etc.">
                            </div>
                            <div class="form-group">
                                <label for="natural-div">Natural Divisibility:</label>
                                <input type="number" id="natural-div" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label for="percentage-div">Percentage Divisibility (0-1):</label>
                                <input type="number" id="percentage-div" value="0.1" min="0" max="1" step="0.1">
                            </div>
                            <button id="create-capacity-btn">Create Capacity</button>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="panel">
                            <h3>Your Capacities</h3>
                            <div id="capacities-list">
                                <p>No capacities found.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Capacity Shares Tab -->
            <div id="shares-tab" class="tab-content">
                <h2>Capacity Shares</h2>
                <div class="flex-container">
                    <div class="flex-column">
                        <div class="panel">
                            <h3>Create New Share</h3>
                            <div class="form-group">
                                <label for="share-receiver">Receiver Tree:</label>
                                <select id="share-receiver"></select>
                            </div>
                            <div class="form-group">
                                <label for="share-provider">Provider Tree:</label>
                                <select id="share-provider"></select>
                            </div>
                            <div class="form-group">
                                <label for="share-capacity">Capacity:</label>
                                <select id="share-capacity"></select>
                            </div>
                            <div class="form-group">
                                <label for="share-percentage">Percentage (0-1):</label>
                                <input type="number" id="share-percentage" value="0.2" min="0" max="1" step="0.1">
                            </div>
                            <button id="create-share-btn">Create Share</button>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="panel">
                            <h3>Your Shares</h3>
                            <div id="shares-list">
                                <p>No shares found.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Gun with a relay server
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
        const user = gun.user();
        
        // Helper functions for DOM manipulation
        const $ = (id) => document.getElementById(id);
        const showElement = (el) => el.classList.remove('hidden');
        const hideElement = (el) => el.classList.add('hidden');
        const setMessage = (elementId, message, isError = false) => {
            const el = $(elementId);
            el.textContent = message;
            el.style.color = isError ? 'red' : 'green';
            setTimeout(() => el.textContent = '', 5000);
        };
        
        // Auth state management
        let currentUser = null;
        
        // Event Listeners for Auth
        $('login-btn').addEventListener('click', async () => {
            const username = $('username').value;
            const password = $('password').value;
            
            if (!username || !password) {
                setMessage('auth-message', 'Please enter username and password', true);
                return;
            }
            
            user.auth(username, password, (ack) => {
                if (ack.err) {
                    setMessage('auth-message', `Login failed: ${ack.err}`, true);
                    return;
                }
                
                currentUser = {
                    username,
                    pub: user.is.pub
                };
                
                $('current-user').textContent = username;
                hideElement($('login-form'));
                showElement($('user-info'));
                showElement($('main-content'));
                loadUserData();
            });
        });
        
        $('signup-btn').addEventListener('click', async () => {
            const username = $('username').value;
            const password = $('password').value;
            
            if (!username || !password) {
                setMessage('auth-message', 'Please enter username and password', true);
                return;
            }
            
            user.create(username, password, (ack) => {
                if (ack.err) {
                    setMessage('auth-message', `Signup failed: ${ack.err}`, true);
                    return;
                }
                
                setMessage('auth-message', 'Account created! Please login.');
            });
        });
        
        $('logout-btn').addEventListener('click', () => {
            user.leave();
            currentUser = null;
            
            showElement($('login-form'));
            hideElement($('user-info'));
            hideElement($('main-content'));
            
            // Clear form fields
            $('username').value = '';
            $('password').value = '';
        });
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show active content
                const tabName = tab.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                $(`${tabName}-tab`).classList.add('active');
            });
        });
        
        // Tree Management
        $('create-tree-btn').addEventListener('click', async () => {
            if (!currentUser) {
                setMessage('auth-message', 'Please login first', true);
                return;
            }
            
            const name = $('tree-name').value;
            const points = parseInt($('tree-points').value);
            const contributorsStr = $('tree-contributors').value;
            const contributors = contributorsStr.split(',').map(id => id.trim()).filter(id => id);
            
            if (!name) {
                alert('Please enter a tree name');
                return;
            }
            
            // Store in Gun under the user's graph
            const treeId = `tree_${Date.now()}`;
            user.get('trees').get(treeId).put({
                id: treeId,
                name,
                points,
                contributors,
                ownerId: user.is.pub,
                createdAt: Date.now()
            }, ack => {
                if (ack.err) {
                    alert(`Error creating tree: ${ack.err}`);
                    return;
                }
                
                alert('Tree created successfully!');
                loadTrees();
                
                // Clear form
                $('tree-name').value = '';
                $('tree-points').value = '100';
                $('tree-contributors').value = '';
            });
        });
        
        // Capacity Management
        $('create-capacity-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            
            const treeSelect = $('capacity-tree');
            const treeId = treeSelect.value;
            
            if (!treeId) {
                alert('Please select a tree');
                return;
            }
            
            const name = $('capacity-name').value;
            const quantity = parseInt($('capacity-quantity').value);
            const unit = $('capacity-unit').value;
            const naturalDiv = parseInt($('natural-div').value);
            const percentageDiv = parseFloat($('percentage-div').value);
            
            if (!name || !quantity || !unit) {
                alert('Please fill all required fields');
                return;
            }
            
            const capacityId = `capacity_${Date.now()}`;
            const capacity = {
                capacityId,
                capacityName: name,
                quantity,
                unit,
                maxDivisibility: {
                    naturalDiv,
                    percentageDiv
                },
                shareDepth: 2,
                expanded: true,
                createdAt: Date.now()
            };
            
            user.get('trees').get(treeId).get('capacities').get(capacityId).put(capacity, ack => {
                if (ack.err) {
                    alert(`Error creating capacity: ${ack.err}`);
                    return;
                }
                
                alert('Capacity created successfully!');
                loadCapacities();
                
                // Clear form
                $('capacity-name').value = '';
                $('capacity-quantity').value = '10';
                $('capacity-unit').value = '';
            });
        });
        
        // Capacity Share Management
        $('create-share-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            
            const receiverId = $('share-receiver').value;
            const providerId = $('share-provider').value;
            const capacityId = $('share-capacity').value;
            const percentage = parseFloat($('share-percentage').value);
            
            if (!receiverId || !providerId || !capacityId || isNaN(percentage)) {
                alert('Please fill all fields');
                return;
            }
            
            // First, get the capacity data
            gun.get(`~${user.is.pub}`).get('trees').get(providerId).get('capacities').get(capacityId).once((capacity) => {
                if (!capacity) {
                    alert('Capacity not found');
                    return;
                }
                
                // Calculate share quantity based on percentage using our functional approach
                const qty = capacity.quantity || 0;
                const maxDiv = capacity.maxDivisibility || { naturalDiv: 1, percentageDiv: 1 };
                
                // Functional calculation for share quantity
                const computeQuantityShare = (capacity, percentage) => {
                    return [
                        // Step 1: Calculate raw quantity
                        rawQuantity => {
                            // Step 2: Apply percentage divisibility constraint
                            const maxPercent = maxDiv.percentageDiv; 
                            return percentage > maxPercent
                                ? Math.round(qty * maxPercent)
                                : rawQuantity;
                        },
                        // Step 3: Apply natural number divisibility constraint
                        percentConstrained => {
                            const naturalDiv = maxDiv.naturalDiv;
                            return Math.floor(percentConstrained / naturalDiv) * naturalDiv;
                        }
                    ].reduce(
                        (value, fn) => fn(value),
                        Math.round(qty * percentage)
                    );
                };
                
                const computedQuantity = computeQuantityShare(capacity, percentage);
                
                // Create the share with metadata
                const shareId = `share_${Date.now()}`;
                const share = {
                    targetTreeId: providerId,
                    targetCapacityId: capacityId,
                    sharePercentage: percentage,
                    computedQuantity,
                    createdAt: Date.now()
                };
                
                user.get('trees').get(receiverId).get('capacityShares').get(shareId).put(share, ack => {
                    if (ack.err) {
                        alert(`Error creating share: ${ack.err}`);
                        return;
                    }
                    
                    alert('Capacity share created successfully!');
                    loadShares();
                });
            });
        });
        
        // Data loading functions
        async function loadUserData() {
            loadTrees();
            loadCapacities();
            loadShares();
        }
        
        function loadTrees() {
            if (!currentUser) return;
            
            const treesList = $('trees-list');
            treesList.innerHTML = 'Loading trees...';
            
            // Clear tree select dropdowns
            $('capacity-tree').innerHTML = '';
            $('share-receiver').innerHTML = '';
            $('share-provider').innerHTML = '';
            
            const trees = [];
            
            user.get('trees').map().once((tree, id) => {
                if (!tree || id === '_' || id === '#') return;
                
                trees.push({...tree, id});
                
                // Add to tree selects
                const option1 = document.createElement('option');
                option1.value = id;
                option1.textContent = tree.name;
                $('capacity-tree').appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = id;
                option2.textContent = tree.name;
                $('share-receiver').appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = id;
                option3.textContent = tree.name;
                $('share-provider').appendChild(option3);
            });
            
            setTimeout(() => {
                if (trees.length === 0) {
                    treesList.innerHTML = '<p>No trees found.</p>';
                    return;
                }
                
                treesList.innerHTML = '';
                trees.forEach(tree => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${tree.name}</h3>
                        <p><strong>ID:</strong> ${tree.id}</p>
                        <p><strong>Points:</strong> ${tree.points}</p>
                        <p><strong>Contributors:</strong> ${tree.contributors ? tree.contributors.join(', ') : 'None'}</p>
                    `;
                    treesList.appendChild(card);
                });
                
                // If we have trees, trigger capacity load for first tree
                if (trees.length > 0 && $('share-provider').value) {
                    loadCapacitiesForTree($('share-provider').value);
                }
            }, 1000);
        }
        
        function loadCapacities() {
            if (!currentUser) return;
            
            const capacitiesList = $('capacities-list');
            capacitiesList.innerHTML = 'Loading capacities...';
            
            const capacities = [];
            
            user.get('trees').map().once((tree, treeId) => {
                if (!tree || treeId === '_' || treeId === '#') return;
                
                user.get('trees').get(treeId).get('capacities').map().once((capacity, capId) => {
                    if (!capacity || capId === '_' || capId === '#') return;
                    
                    capacities.push({
                        ...capacity,
                        id: capId,
                        treeId,
                        treeName: tree.name
                    });
                });
            });
            
            setTimeout(() => {
                if (capacities.length === 0) {
                    capacitiesList.innerHTML = '<p>No capacities found.</p>';
                    return;
                }
                
                capacitiesList.innerHTML = '';
                capacities.forEach(capacity => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${capacity.capacityName}</h3>
                        <p><strong>Tree:</strong> ${capacity.treeName}</p>
                        <p><strong>Quantity:</strong> ${capacity.quantity} ${capacity.unit}</p>
                        <p><strong>Divisibility:</strong> Natural: ${capacity.maxDivisibility?.naturalDiv || 1}, 
                                                 Percentage: ${capacity.maxDivisibility?.percentageDiv || 1}</p>
                    `;
                    capacitiesList.appendChild(card);
                });
            }, 1500);
        }
        
        function loadCapacitiesForTree(treeId) {
            if (!currentUser) return;
            
            const capacitySelect = $('share-capacity');
            capacitySelect.innerHTML = '';
            
            user.get('trees').get(treeId).get('capacities').map().once((capacity, id) => {
                if (!capacity || id === '_' || id === '#') return;
                
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${capacity.capacityName} (${capacity.quantity} ${capacity.unit})`;
                capacitySelect.appendChild(option);
            });
        }
        
        // Update capacity dropdown when provider tree changes
        $('share-provider').addEventListener('change', (e) => {
            loadCapacitiesForTree(e.target.value);
        });
        
        function loadShares() {
            if (!currentUser) return;
            
            const sharesList = $('shares-list');
            sharesList.innerHTML = 'Loading shares...';
            
            const shares = [];
            
            user.get('trees').map().once((tree, treeId) => {
                if (!tree || treeId === '_' || treeId === '#') return;
                
                user.get('trees').get(treeId).get('capacityShares').map().once((share, shareId) => {
                    if (!share || shareId === '_' || shareId === '#') return;
                    
                    shares.push({
                        ...share,
                        id: shareId,
                        receiverTreeId: treeId,
                        receiverTreeName: tree.name
                    });
                });
            });
            
            setTimeout(() => {
                if (shares.length === 0) {
                    sharesList.innerHTML = '<p>No capacity shares found.</p>';
                    return;
                }
                
                // We need to resolve the provider tree names
                sharesList.innerHTML = '';
                
                shares.forEach(share => {
                    // Get provider tree info
                    user.get('trees').get(share.targetTreeId).once((providerTree) => {
                        if (!providerTree) return;
                        
                        // Get capacity info
                        user.get('trees').get(share.targetTreeId).get('capacities').get(share.targetCapacityId).once((capacity) => {
                            const card = document.createElement('div');
                            card.className = 'card';
                            card.innerHTML = `
                                <h3>Share from ${providerTree.name}</h3>
                                <p><strong>Receiver:</strong> ${share.receiverTreeName}</p>
                                <p><strong>Capacity:</strong> ${capacity ? capacity.capacityName : 'Unknown'}</p>
                                <p><strong>Share:</strong> ${(share.sharePercentage * 100).toFixed(1)}%</p>
                                <p><strong>Computed Quantity:</strong> ${share.computedQuantity} ${capacity ? capacity.unit : ''}</p>
                            `;
                            sharesList.appendChild(card);
                        });
                    });
                });
            }, 1500);
        }
        
        // Check for existing session
        user.recall({ sessionStorage: true }, ack => {
            if (user.is) {
                currentUser = {
                    username: ack.put.alias,
                    pub: user.is.pub
                };
                
                $('current-user').textContent = currentUser.username;
                hideElement($('login-form'));
                showElement($('user-info'));
                showElement($('main-content'));
                loadUserData();
            }
        });
    </script>
</body>
</html> 